<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Kahoot - Acceso</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.0/socket.io.js"></script>
    <style>
        :root {
            --primary-color: #6366f1;
            --success-color: #22c55e;
            --danger-color: #ef4444;
            --warning-color: #f59e0b;
            --background-color: #f8fafc;
            --text-color: #1e293b;
            --shadow-sm: 0 1px 3px rgba(0,0,0,0.1);
            --shadow-md: 0 4px 6px -1px rgba(0,0,0,0.1);
            --shadow-lg: 0 10px 15px -3px rgba(0,0,0,0.1);
        }

        body { 
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
            padding: 2rem;
            text-align: center;
            background-color: var(--background-color);
            color: var(--text-color);
            line-height: 1.5;
        }

        .container {
            max-width: 800px;
            margin: 2rem auto;
            background: white;
            padding: 2rem;
            border-radius: 1rem;
            box-shadow: var(--shadow-lg);
        }

        h1 {
            color: var(--primary-color);
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
            font-weight: 700;
        }

        .author {
            color: var(--text-color);
            opacity: 0.8;
            font-size: 1rem;
            margin-bottom: 2rem;
            font-style: italic;
        }

        h2 {
            font-size: 1.8rem;
            color: var(--text-color);
            margin-bottom: 1.5rem;
        }

        .form-box {
            padding: 2rem;
            background: #f8fafc;
            border-radius: 0.75rem;
            margin-bottom: 2rem;
        }

        input[type="text"] {
            width: 100%;
            max-width: 400px;
            padding: 0.75rem 1rem;
            border: 2px solid #e2e8f0;
            border-radius: 0.5rem;
            font-size: 1rem;
            transition: border-color 0.2s;
            margin-bottom: 1.5rem;
        }

        input[type="text"]:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }

        button {
            padding: 0.75rem 1.5rem;
            margin: 0.5rem;
            cursor: pointer;
            border: none;
            border-radius: 0.5rem;
            color: white;
            font-weight: 600;
            font-size: 1rem;
            transition: all 0.2s;
            background-color: var(--primary-color);
        }

        button:hover {
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }

        button:disabled {
            opacity: 0.7;
            cursor: not-allowed;
            transform: none;
        }

        /* Estilos de Admin */
        #admin-view-container {
            background: #ffffff;
            border-radius: 1rem;
            padding: 2rem;
            box-shadow: var(--shadow-sm);
        }

        #admin-view-container button {
            background-color: var(--primary-color);
        }

        #start-btn {
            background-color: var(--success-color);
        }

        #end-btn {
            background-color: var(--danger-color);
        }

        #controls {
            display: flex;
            gap: 1rem;
            justify-content: center;
            margin: 2rem 0;
        }

        /* Estilos de Jugador */
        #jugador-view-container .pregunta-box {
            background: #f8fafc;
            padding: 2rem;
            border-radius: 1rem;
            margin: 2rem 0;
        }

        #jugador-view-container .opcion-btn {
            padding: 1rem 2rem;
            margin: 0.75rem auto;
            font-size: 1.1rem;
            border: none;
            border-radius: 0.75rem;
            color: white;
            width: 90%;
            max-width: 500px;
            transition: all 0.2s;
            display: block;
        }

        #A-btn {
            background-color: var(--success-color);
        }

        #B-btn {
            background-color: var(--primary-color);
        }

        #C-btn {
            background-color: var(--warning-color);
        }

        .opcion-btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        #score-list {
            list-style: none;
            padding: 0;
            margin: 1rem 0;
        }

        #score-list li, #player-score-list li {
            padding: 0.75rem;
            margin: 0.5rem 0;
            background: #f8fafc;
            border-radius: 0.5rem;
            font-weight: 500;
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: var(--text-color);
        }

        .player-header {
            background: #f8fafc;
            padding: 1rem;
            border-radius: 0.75rem;
            margin-bottom: 1.5rem;
            text-align: center;
        }

        .scores-container {
            background: white;
            padding: 1.5rem;
            border-radius: 0.75rem;
            margin-top: 2rem;
            box-shadow: var(--shadow-sm);
        }

        .scores-container h3 {
            color: var(--primary-color);
            margin-bottom: 1rem;
        }

        #mensaje-error, #mensaje-servidor {
            color: var(--danger-color);
            font-weight: 500;
            margin-top: 1rem;
        }
        
        .position-badge {
            background: var(--primary-color);
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            font-weight: 600;
            margin-right: 0.5rem;
        }

        .current-player {
            background: var(--success-color);
        }

        hr {
            border: none;
            border-top: 2px solid #e2e8f0;
            margin: 2rem 0;
        }

        #game-title {
            color: var(--primary-color);
            font-size: 1.5rem;
            font-weight: 700;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Kahoot de Redes</h1>
        <p class="author">Autor: Germán Alvarez</p>
        
        <div id="login-form-container" class="form-box">
            <h2>Ingresa tu Nombre</h2>
            <input type="text" id="nombre-input" placeholder="Nombre" required style="padding: 10px; width: 80%; margin-bottom: 15px;">
            <button onclick="unirseAlJuego()">Unirse al Juego</button>
            <p id="mensaje-error" style="color: red; margin-top: 15px;"></p>
        </div>

        <div id="admin-view-container" style="display:none;">
            <h2>🎮 Kahoot Admin (IP: <span id="admin-ip-display"></span>)</h2>
            <p>Control de juego centralizado.</p>
            
            <div id="controls">
                <button id="start-btn">INICIAR JUEGO</button>
                <button id="next-btn" disabled>SIGUIENTE PREGUNTA</button>
                <button id="end-btn" disabled>FINALIZAR JUEGO</button>
            </div>

            <hr>
            <h3>Estado Actual</h3>
            <p id="status-display">Esperando comando de inicio...</p>

            <h3>Puntuaciones</h3>
            <ul id="score-list"></ul>
        </div>

        <div id="jugador-view-container" style="display:none;">
            <div class="player-header">
                <p>Conectado como: <strong id="player-name"></strong></p>
                <h2 id="game-title">Puntuación: 0</h2>
                <p>Jugadores conectados: <strong id="players-count">0</strong></p>
            </div>
            <div class="pregunta-box">
                <h3 id="pregunta-texto">Esperando que el Administrador inicie el juego...</h3>
                <div id="opciones-area"></div>
            </div>
            <div class="scores-container">
                <h3>Tabla de Posiciones</h3>
                <ul id="player-score-list"></ul>
            </div>
            <p id="mensaje-servidor" style="color: red; margin-top: 15px;">Mensajes del Servidor.</p>
        </div>
    </div>

    <script>
        const socket = io(); 
        let juego_activo = false;
        let nombreJugador = '';

        // --- FUNCIONES DE VISTA ---
        function mostrarVista(role, data = {}) {
            document.getElementById('login-form-container').style.display = 'none';
            document.getElementById('admin-view-container').style.display = 'none';
            document.getElementById('jugador-view-container').style.display = 'none';

            if (role === 'admin') {
                document.getElementById('admin-view-container').style.display = 'block';
                document.getElementById('admin-ip-display').textContent = 'Acceso Remoto'; // Muestra que estás como admin
                // Dispara el comando inicial para cargar el estado
                setTimeout(() => {
                    socket.emit('comando_admin', {comando: 'estado'}); 
                }, 100); 
            } else {
                nombreJugador = data.nombre;
                document.getElementById('jugador-view-container').style.display = 'block';
                document.getElementById('player-name').textContent = nombreJugador;
            }
        }

        function unirseAlJuego() {
            const nombre = document.getElementById('nombre-input').value.trim();
            const mensajeError = document.getElementById('mensaje-error');
            mensajeError.textContent = '';
            
            if (!nombre) {
                mensajeError.textContent = '¡Ingresa un nombre para continuar!';
                return;
            }
            // Envía el nombre al servidor para validación
            socket.emit('conectar_jugador', {nombre: nombre});
        }
        
        function enviarRespuesta(opcion) {
            document.querySelectorAll('.opcion-btn').forEach(btn => btn.disabled = true);
            socket.emit('enviar_respuesta', {respuesta: opcion});
        }


        // --- HANDLERS DE SOCKET.IO ---

        socket.on('connect', () => {
            console.log('Conectado al servidor.');
        });
        
        // Maneja el éxito del login (Admin o Jugador)
        socket.on('login_success', (data) => {
            mostrarVista(data.role, data);
        });

        // Maneja el error si ya hay un Admin activo
        socket.on('login_error', (msg) => {
            document.getElementById('mensaje-error').textContent = msg;
        });

        // --- LÓGICA DE JUGADOR (Mismo código de jugador.html, pero ahora está aquí) ---

        socket.on('mensaje', (msg) => {
            document.getElementById('mensaje-servidor').textContent = msg;
            document.querySelectorAll('.opcion-btn').forEach(btn => btn.disabled = false); // Habilitar botones tras un mensaje
        });
        
        socket.on('mensaje_broadcast', (msg) => {
            document.getElementById('mensaje-servidor').textContent = msg;
        });

        socket.on('nueva_pregunta', (data) => {
            document.getElementById('pregunta-texto').textContent = data.texto;
            const opcionesArea = document.getElementById('opciones-area');
            opcionesArea.innerHTML = '';
            
            data.opciones.forEach((opcion, index) => {
                const letra = ['A', 'B', 'C'][index];
                const btn = document.createElement('button');
                btn.id = `${letra}-btn`;
                btn.className = 'opcion-btn';
                btn.textContent = `${letra}) ${opcion}`;
                btn.addEventListener('click', () => enviarRespuesta(letra));
                opcionesArea.appendChild(btn);
            });
            
            document.getElementById('mensaje-servidor').textContent = '¡Ronda iniciada! Selecciona tu respuesta.';
        });
        
        socket.on('actualizar_puntuacion', (scores) => {
            // Actualizar el contador de jugadores
            const jugadoresConectados = Object.keys(scores).length;
            document.getElementById('players-count').textContent = jugadoresConectados;

            // Muestra la puntuación del jugador actual
            const currentScore = Object.values(scores).find(info => info.nombre === nombreJugador);
            if (currentScore) {
                document.getElementById('game-title').textContent = `Puntuación: ${currentScore.puntuacion}`;
            }

            // Actualizar la tabla de posiciones
            const playerScoreList = document.getElementById('player-score-list');
            playerScoreList.innerHTML = '';
            
            const scoresArray = Object.values(scores)
                .sort((a, b) => b.puntuacion - a.puntuacion);

            scoresArray.forEach((info, index) => {
                const li = document.createElement('li');
                li.className = info.nombre === nombreJugador ? 'current-player' : '';
                
                const position = document.createElement('span');
                position.className = 'position-badge';
                position.textContent = `#${index + 1}`;

                const playerInfo = document.createElement('span');
                playerInfo.textContent = `${info.nombre}: ${info.puntuacion} puntos`;
                
                const status = document.createElement('span');
                status.textContent = info.respondido ? '✅' : '⏳';
                
                li.appendChild(position);
                li.appendChild(playerInfo);
                li.appendChild(status);
                playerScoreList.appendChild(li);
            });
        });


        // --- LÓGICA DE ADMIN (Mismo código de admin.html) ---

        socket.on('admin_estado', (estado) => {
            // Lógica de actualización de botones y lista de jugadores (copiada de admin.html)
            
            // Actualizar botones y estado
            document.getElementById('start-btn').disabled = estado.activo;
            document.getElementById('next-btn').disabled = !estado.activo;
            document.getElementById('end-btn').disabled = !estado.activo;
            
            if (estado.activo) {
                const ronda = estado.ronda_actual === -1 ? 0 : estado.ronda_actual + 1;
                document.getElementById('status-display').textContent = `Juego ACTIVO. Ronda: ${ronda}`;
            } else {
                document.getElementById('status-display').textContent = 'Juego INACTIVO. Listo para iniciar.';
            }

            // Actualizar lista de puntuaciones
            const scoreList = document.getElementById('score-list');
            scoreList.innerHTML = '';
            const scoresArray = Object.values(estado.puntuaciones).sort((a, b) => b.puntuacion - a.puntuacion);
            
            if (scoresArray.length === 0) {
                 scoreList.innerHTML = '<li>Aún no hay jugadores conectados.</li>';
            } else {
                scoresArray.forEach((info, index) => {
                    const li = document.createElement('li');
                    let respuestaEstado = '';
                    if (estado.activo && estado.ronda_actual !== -1) {
                         respuestaEstado = info.respondido ? ' ✅' : ' ❌';
                    }
                    li.textContent = `#${index + 1}: ${info.nombre}: ${info.puntuacion} puntos${respuestaEstado}`;
                    scoreList.appendChild(li);
                });
            }
        });

        // Configuración de botones de Admin
        document.getElementById('start-btn').addEventListener('click', () => {
            socket.emit('comando_admin', {comando: 'iniciar'});
        });
        document.getElementById('next-btn').addEventListener('click', () => {
            socket.emit('comando_admin', {comando: 'siguiente'});
        });
        document.getElementById('end-btn').addEventListener('click', () => {
            socket.emit('comando_admin', {comando: 'finalizar'});
        });
    </script>
</body>
</html>